<!doctype html>
<html lang="de" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>{% block title %}SPKH{% endblock %}</title>

  <link rel="icon" href="{{ url_for('static', path='favicon.svg') }}"/>
  <link rel="stylesheet" href="{{ url_for('static', path='css/theme.css') }}"/>

  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    (function () {
      const KEY = 'dm_theme';
      try {
        const saved = localStorage.getItem(KEY);
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const theme = saved || (prefersDark ? 'dark' : 'light');
        document.documentElement.dataset.theme = theme;
        document.documentElement.classList.toggle('dark', theme === 'dark');
      } catch (e) {
        document.documentElement.dataset.theme = 'light';
        document.documentElement.classList.remove('dark');
      }
    })();
  </script>

  {% block head_extra %}{% endblock %}
</head>
<body class="tw-compat min-h-screen flex flex-col bg-[var(--bg)] text-[var(--ink)]">
  {% set p = request.url.path %}
  {% set current = active if active is defined and active else (
      'dashboard' if p.startswith('/dashboard')
      else 'upload' if p.startswith('/upload')
      else 'documents' if p.startswith('/documents')
      else 'trash' if p.startswith('/trash')
      else 'search' if p.startswith('/search')
      else 'security-info' if p.startswith('/security-info')
      else ''
  ) %}

  <!-- NAVBAR -->
  <header class="sticky top-0 z-40 w-full border-b border-slate-200/60 bg-[var(--card)]/90 backdrop-blur-md">
    <nav class="mx-auto flex h-14 max-w-7xl items-center justify-between px-3 sm:px-4 lg:px-6">
      <!-- Brand -->
      <a href="/dashboard"
         class="flex items-center gap-2 rounded-full px-2 py-1 text-sm font-semibold text-[var(--ink)] shadow-sm ring-1 ring-slate-200/70 bg-[var(--bg)]/80">
        <span class="inline-flex h-7 w-7 items-center justify-center rounded-full bg-gradient-to-tr from-sky-500 to-indigo-500 text-xs font-bold text-white shadow-sm">
          DM
        </span>
        <span class="hidden sm:inline">SPKH Dokumentenmanager</span>
        <span class="inline sm:hidden">SPKH</span>
      </a>

      {% if user %}
        <!-- Hauptnavigation -->
        <div class="hidden items-center gap-1 rounded-full px-1 py-0.5 text-xs font-medium shadow-sm ring-1 ring-slate-200/70 bg-[var(--bg)]/70 sm:flex">
          <a href="/dashboard"
             class="px-3 py-1.5 rounded-full transition
                    {% if current=='dashboard' %}
                      bg-slate-900 text-white
                    {% else %}
                      text-slate-700 hover:bg-slate-200/80
                    {% endif %}">
            Dashboard
          </a>
          <a href="/upload"
             class="px-3 py-1.5 rounded-full transition
                    {% if current=='upload' %}
                      bg-slate-900 text-white
                    {% else %}
                      text-slate-700 hover:bg-slate-200/80
                    {% endif %}">
            Upload
          </a>
          <a href="/documents"
             class="px-3 py-1.5 rounded-full transition
                    {% if current=='documents' %}
                      bg-slate-900 text-white
                    {% else %}
                      text-slate-700 hover:bg-slate-200/80
                    {% endif %}">
            Documents
          </a>

          <a href="/trash"
             class="px-3 py-1.5 rounded-full transition
                    {% if current=='trash' %}
                      bg-slate-900 text-white
                    {% else %}
                      text-slate-700 hover:bg-slate-200/80
                    {% endif %}">
            Papierkorb
          </a>

          <a href="/security-info"
             class="px-3 py-1.5 rounded-full transition
                    {% if current=='security-info' %}
                      bg-slate-900 text-white
                    {% else %}
                      text-slate-700 hover:bg-slate-200/80
                    {% endif %}">
            Security
          </a>
        </div>
      {% endif %}

      <!-- Right side -->
      <div class="flex items-center gap-2 sm:gap-3">
        {% if user %}
          <!-- Theme toggle -->
          <button
            id="theme-toggle"
            class="inline-flex h-8 w-8 items-center justify-center rounded-full border border-slate-300 bg-[var(--bg)] text-xs shadow-sm transition hover:bg-slate-200/70"
            aria-pressed="false"
            title="Theme wechseln">
            üåô
          </button>

          <!-- Settings -->
          <button
            id="settings-toggle"
            type="button"
            aria-label="Einstellungen"
            class="inline-flex h-8 w-8 items-center justify-center rounded-full border border-slate-300 bg-[var(--bg)] text-xs shadow-sm transition hover:bg-slate-200/70">
            ‚öô
          </button>

          <!-- User + Logout -->
          <div class="flex items-center gap-2">
            <span class="hidden text-xs text-[var(--ink-muted)] sm:inline">
              {{ user.username or user.email }}
            </span>
            <form method="post" action="/auth/logout-web">
              <button
                class="inline-flex items-center rounded-full border border-slate-300 bg-[var(--bg)] px-3 py-1 text-xs font-medium text-[var(--ink)] shadow-sm transition hover:bg-slate-200/70">
                Logout
              </button>
            </form>
          </div>
        {% else %}
          <div class="flex items-center gap-2 text-xs">
            <a
              href="/auth/login-web"
              class="rounded-full border border-slate-300 bg-[var(--bg)] px-3 py-1 font-medium text-[var(--ink)] shadow-sm transition hover:bg-slate-200/70">
              Login
            </a>
            <a
              href="/auth/register-web"
              class="rounded-full bg-slate-900 px-3 py-1 font-medium text-white shadow-sm transition hover:bg-slate-800">
              Registrieren
            </a>
          </div>
        {% endif %}
      </div>
    </nav>
  </header>

  <!-- TOASTS (Flash Cookie: dm_toast) -->
  <div id="toast-container" class="fixed left-1/2 top-20 z-50 w-[520px] max-w-[92vw] -translate-x-1/2 flex flex-col gap-3 px-2"></div>

  <!-- MAIN -->
  <main class="mx-auto mt-4 flex w-full max-w-7xl flex-1 flex-col px-3 pb-10 sm:px-4 lg:px-6">
    {% if error %}
      <div class="mb-4 rounded-lg border border-red-200 bg-red-50 px-4 py-2 text-sm text-red-700">
        {{ error }}
      </div>
    {% endif %}
    {% block content %}{% endblock %}
  </main>

  <!-- SETTINGS PANEL -->
  <div
    id="settings-panel"
    class="fixed right-3 top-16 z-50 hidden w-80 max-w-full"
  >
    <div class="card rounded-2xl border border-slate-300 bg-[var(--card)]/95 p-4 shadow-xl">
      <div class="mb-2 flex items-center justify-between">
        <div class="text-sm font-semibold text-[var(--ink)]">Einstellungen</div>
        <button
          type="button"
          id="settings-close"
          class="btn ghost inline-flex items-center rounded-full px-2 py-0.5 text-xs"
        >
          ‚úï
        </button>
      </div>

      <!-- Men√º -->
      <div id="settings-view-menu">
        <div class="mb-3 text-xs text-[var(--ink-muted)]">
          W√§hle einen Bereich, den du anpassen m√∂chtest.
        </div>
        <div class="flex flex-col gap-2 text-xs">
          <button
            type="button"
            class="btn inline-flex justify-start rounded-lg border border-slate-300 bg-[var(--bg)] px-3 py-2 text-xs font-medium text-[var(--ink)] shadow-sm hover:bg-slate-200/70"
            data-settings-open="design"
          >
            Hintergrund- und Schriftfarbe √§ndern
          </button>
          <button
            type="button"
            class="btn ghost inline-flex justify-start rounded-lg border border-transparent px-3 py-2 text-xs font-medium text-[var(--ink-muted)] hover:bg-slate-200/40"
            data-settings-open="account"
          >
            Account
          </button>
        </div>
      </div>

      <!-- Design -->
      <div id="settings-view-design" class="hidden">
        <div class="mb-2 flex items-center justify-between">
          <div class="text-xs font-semibold text-[var(--ink)]">Design anpassen</div>
          <button
            type="button"
            class="btn ghost rounded-full px-2 py-0.5 text-[11px]"
            id="settings-back-from-design"
          >
            ‚Üê Zur√ºck
          </button>
        </div>

        <div class="mb-3 text-xs text-[var(--ink-muted)]">
          Farben f√ºr Hintergrund, Karten und Schrift anpassen.
        </div>

        <div class="flex flex-col gap-2 text-xs">
          <label class="flex items-center justify-between gap-3">
            <span>Hintergrund</span>
            <input type="color" id="color-bg" class="h-6 w-10 cursor-pointer rounded border border-slate-300 bg-transparent" />
          </label>

          <label class="flex items-center justify-between gap-3">
            <span>Boxen / Karten</span>
            <input type="color" id="color-card" class="h-6 w-10 cursor-pointer rounded border border-slate-300 bg-transparent" />
          </label>

          <label class="flex items-center justify-between gap-3">
            <span>Schrift</span>
            <input type="color" id="color-ink" class="h-6 w-10 cursor-pointer rounded border border-slate-300 bg-transparent" />
          </label>

          <label class="flex items-center justify-between gap-3">
            <span>Prim√§rfarbe</span>
            <input type="color" id="color-primary" class="h-6 w-10 cursor-pointer rounded border border-slate-300 bg-transparent" />
          </label>

          <label class="flex items-center justify-between gap-3">
            <span>Akzent</span>
            <input type="color" id="color-accent" class="h-6 w-10 cursor-pointer rounded border border-slate-300 bg-transparent" />
          </label>
        </div>

        <div class="mt-4 flex gap-2">
          <button
            type="button"
            id="settings-reset"
            class="btn flex-1 rounded-lg border border-slate-300 bg-[var(--bg)] px-2 py-1.5 text-xs font-medium text-[var(--ink)] hover:bg-slate-200/70"
          >
            Zur√ºcksetzen
          </button>
          <button
            type="button"
            id="settings-apply"
            class="btn primary flex-1 rounded-lg bg-slate-900 px-2 py-1.5 text-xs font-medium text-white hover:bg-slate-800"
          >
            Anwenden
          </button>
        </div>

        <div class="mt-2 text-[11px] text-[var(--ink-muted)]">
          Auswahl wird lokal im Browser gespeichert.
        </div>
      </div>

      <!-- Account -->
      <div id="settings-view-account" class="hidden">
        <div class="mb-2 flex items-center justify-between">
          <div class="text-xs font-semibold text-[var(--ink)]">Account</div>
          <button
            type="button"
            class="btn ghost rounded-full px-2 py-0.5 text-[11px]"
            id="settings-back-from-account"
          >
            ‚Üê Zur√ºck
          </button>
        </div>

        <div class="mb-3 text-xs text-[var(--ink-muted)]">
          Verwalte deine Profildaten und Sicherheitseinstellungen.
        </div>

        <ul class="mb-3 ml-4 list-disc text-[11px] text-[var(--ink-muted)]">
          <li>Name / Anzeigename √§ndern</li>
          <li>E-Mail-Adresse aktualisieren</li>
          <li>Sprache des Kontos anpassen</li>
          <li>Passwort mit Sicherheitsabfrage √§ndern</li>
          <li>Konto bei Bedarf dauerhaft l√∂schen</li>
        </ul>

        <a
          href="/profile"
          class="btn primary mb-2 inline-flex w-full justify-center rounded-lg bg-slate-900 px-3 py-1.5 text-xs font-medium text-white hover:bg-slate-800"
        >
          Profil-Einstellungen √∂ffnen
        </a>

        <div class="text-[11px] text-[var(--ink-muted)]">
          Hinweis: √Ñnderungen an E-Mail und Passwort erfordern dein aktuelles Passwort.
        </div>
      </div>
    </div>
  </div>

  <!-- Theme Toggle Logic -->
  <script>
    (function(){
      const btn = document.getElementById('theme-toggle');
      if (!btn) return;
      const KEY = 'dm_theme';
      function setTheme(theme){
        document.documentElement.dataset.theme = theme;
        localStorage.setItem(KEY, theme);
        document.documentElement.classList.toggle('dark', theme === 'dark');
        btn.setAttribute('aria-pressed', theme === 'dark');
        btn.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
      }
      btn.addEventListener('click', () => {
        const next = (document.documentElement.dataset.theme === 'dark') ? 'light' : 'dark';
        setTheme(next);
      });
      setTheme(document.documentElement.dataset.theme || 'light');
    })();
  </script>

  <!-- Toast Logic -->
  <script>
    (function () {
      function getCookie(name) {
        const v = document.cookie.split('; ').find((row) => row.startsWith(name + '='));
        return v ? v.split('=')[1] : null;
      }

      function clearCookie(name) {
        document.cookie = name + '=; Max-Age=0; path=/; samesite=lax';
      }

      function b64UrlToBytes(b64url) {
        let s = b64url.replace(/-/g, '+').replace(/_/g, '/');
        const pad = s.length % 4;
        if (pad) s += '='.repeat(4 - pad);
        const bin = atob(s);
        const bytes = new Uint8Array(bin.length);
        for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
        return bytes;
      }

      function decodeToast(value) {
        try {
          const bytes = b64UrlToBytes(value);
          const text = new TextDecoder('utf-8').decode(bytes);
          return JSON.parse(text);
        } catch (e) {
          return null;
        }
      }

      function levelClasses(level) {
        if (level === 'success') return 'border-emerald-200 bg-emerald-50 text-emerald-900';
        if (level === 'error') return 'border-rose-200 bg-rose-50 text-rose-900';
        if (level === 'warning') return 'border-amber-200 bg-amber-50 text-amber-900';
        return 'border-slate-200 bg-slate-50 text-slate-900';
      }

      function showToast(toast) {
        const container = document.getElementById('toast-container');
        if (!container || !toast || !toast.message) return;

        const el = document.createElement('div');
        el.className = 'w-full rounded-2xl border px-4 py-3 text-sm shadow-lg ' + levelClasses(toast.level || 'info');

        const top = document.createElement('div');
        top.className = 'flex items-start justify-between gap-2';

        const body = document.createElement('div');
        body.className = 'min-w-0';

        if (toast.title) {
          const title = document.createElement('div');
          title.className = 'text-[11px] font-semibold';
          title.textContent = toast.title;
          body.appendChild(title);
        }

        const msg = document.createElement('div');
        msg.className = 'text-xs';
        msg.textContent = toast.message;
        body.appendChild(msg);

        const close = document.createElement('button');
        close.type = 'button';
        close.className = 'ml-2 rounded-lg px-2 py-1 text-sm font-semibold hover:bg-black/5';
        close.textContent = '√ó';
        close.addEventListener('click', () => el.remove());

        top.appendChild(body);
        top.appendChild(close);
        el.appendChild(top);

        container.appendChild(el);
        setTimeout(() => { try { el.remove(); } catch (e) {} }, 4500);
      }

      const raw = getCookie('dm_toast');
      if (!raw) return;
      clearCookie('dm_toast');
      const toast = decodeToast(raw);
      showToast(toast);
    })();
  </script>

  <!-- Settings-Panel / Custom Theme -->
  <script>
    (function () {
      const root = document.documentElement;
      const STORAGE_KEY = "dm_custom_theme_v1";

      const panel = document.getElementById("settings-panel");
      const toggleBtn = document.getElementById("settings-toggle");
      const closeBtn = document.getElementById("settings-close");

      const viewMenu = document.getElementById("settings-view-menu");
      const viewDesign = document.getElementById("settings-view-design");
      const viewAccount = document.getElementById("settings-view-account");

      const openDesignBtn = panel ? panel.querySelector("[data-settings-open='design']") : null;
      const openAccountBtn = panel ? panel.querySelector("[data-settings-open='account']") : null;
      const backDesignBtn = document.getElementById("settings-back-from-design");
      const backAccountBtn = document.getElementById("settings-back-from-account");

      const inputs = {
        bg: document.getElementById("color-bg"),
        card: document.getElementById("color-card"),
        ink: document.getElementById("color-ink"),
        primary: document.getElementById("color-primary"),
        accent: document.getElementById("color-accent"),
      };

      const varMap = {
        bg: "--bg",
        card: "--card",
        ink: "--ink",
        primary: "--primary",
        accent: "--accent",
      };

      function showView(name) {
        if (!panel) return;
        if (name === "menu") {
          viewMenu.style.display = "block";
          viewDesign.style.display = "none";
          viewAccount.style.display = "none";
        } else if (name === "design") {
          viewMenu.style.display = "none";
          viewDesign.style.display = "block";
          viewAccount.style.display = "none";
        } else if (name === "account") {
          viewMenu.style.display = "none";
          viewDesign.style.display = "none";
          viewAccount.style.display = "block";
        }
      }

      if (toggleBtn && panel) {
        toggleBtn.addEventListener("click", () => {
          const isHidden = panel.style.display === "none" || !panel.style.display;
          if (isHidden) {
            showView("menu");
            panel.style.display = "block";
          } else {
            panel.style.display = "none";
          }
        });
      }

      if (closeBtn && panel) {
        closeBtn.addEventListener("click", () => {
          panel.style.display = "none";
        });
      }

      if (openDesignBtn) {
        openDesignBtn.addEventListener("click", () => showView("design"));
      }
      if (openAccountBtn) {
        openAccountBtn.addEventListener("click", () => showView("account"));
      }
      if (backDesignBtn) {
        backDesignBtn.addEventListener("click", () => showView("menu"));
      }
      if (backAccountBtn) {
        backAccountBtn.addEventListener("click", () => showView("menu"));
      }

      function loadThemeFromStorage() {
        try {
          const raw = window.localStorage.getItem(STORAGE_KEY);
          if (!raw) return;
          const data = JSON.parse(raw);

          Object.keys(varMap).forEach((key) => {
            if (data[key]) {
              root.style.setProperty(varMap[key], data[key]);
              if (inputs[key]) {
                inputs[key].value = data[key];
              }
            }
          });
        } catch (e) {
          console.warn("Cannot load custom theme", e);
        }
      }

      function collectFromInputs() {
        const out = {};
        Object.keys(inputs).forEach((key) => {
          const el = inputs[key];
          if (el && el.value) {
            out[key] = el.value;
          }
        });
        return out;
      }

      function applyTheme(data) {
        Object.keys(varMap).forEach((key) => {
          if (data[key]) {
            root.style.setProperty(varMap[key], data[key]);
          }
        });
      }

      function resetTheme() {
        Object.values(varMap).forEach((cssVar) => {
          root.style.removeProperty(cssVar);
        });
        window.localStorage.removeItem(STORAGE_KEY);
        Object.keys(inputs).forEach((key) => {
          if (inputs[key]) inputs[key].value = "";
        });
      }

      const applyBtn = document.getElementById("settings-apply");
      const resetBtn = document.getElementById("settings-reset");

      if (applyBtn) {
        applyBtn.addEventListener("click", () => {
          const data = collectFromInputs();
          applyTheme(data);
          try {
            window.localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
          } catch (e) {
            console.warn("Cannot save custom theme", e);
          }
        });
      }

      if (resetBtn) {
        resetBtn.addEventListener("click", () => {
          resetTheme();
        });
      }

      loadThemeFromStorage();
    })();
  </script>

  <!-- no-ctrl-multi: Multi-Select ohne STRG -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      document.querySelectorAll("select[multiple].no-ctrl-multi").forEach((sel) => {
        sel.addEventListener("mousedown", (e) => {
          const opt = e.target;
          if (opt && opt.tagName === "OPTION") {
            e.preventDefault();
            opt.selected = !opt.selected;
            sel.dispatchEvent(new Event("change", { bubbles: true }));
          }
        });
      });
    });
  </script>

  {% block body_end %}{% endblock %}
</body>
</html>
