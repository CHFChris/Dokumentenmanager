{# app/web/templates/document_view.html #}
{% extends "base.html" %}

{% block title %}Dokument ansehen · SPKH{% endblock %}

{% block content %}
<div class="mx-auto max-w-6xl px-4 py-6 space-y-5">

  <!-- Back link -->
  <a href="/documents"
     class="inline-flex items-center text-xs font-medium text-[var(--ink-muted)] hover:text-[var(--ink)]">
    <span class="mr-1">←</span>
    Zur Dokumentenübersicht
  </a>

  <!-- Title / Intro -->
  <div>
    <div class="text-[11px] uppercase tracking-wide text-[var(--ink-muted)] mb-1">
      Dokumentansicht
    </div>
    <h1 class="text-2xl font-semibold text-[var(--ink)] break-words">
      {{ doc.original_filename or doc.filename or doc.name }}
    </h1>
    <p class="mt-1 text-sm text-[var(--ink-muted)]">
      Vorschau, Basisdetails und Download.
    </p>
  </div>

  {# Dateiname und Endungen im Template auswerten #}
  {% set filename = (doc.original_filename or doc.filename or doc.name or '') %}
  {% set filename_lower = filename|lower %}
  {% set is_pdf_view = filename_lower.endswith('.pdf') %}
  {% set is_docx = filename_lower.endswith('.docx') %}

  <div class="grid gap-5 lg:grid-cols-3">

    {# LEFT: Vorschau-Bereich #}
    <div class="lg:col-span-2 rounded-2xl border border-slate-200/80 bg-[var(--card)]/95 shadow-sm p-4 space-y-3">

      {% if is_pdf_view %}
        <div class="flex items-center justify-between">
          <span class="text-xs font-medium uppercase tracking-wide text-[var(--ink-muted)]">
            PDF-Vorschau
          </span>
          <span class="text-[11px] text-[var(--ink-muted)]">
            Direkt im Browser gerendert
          </span>
        </div>

        <!-- PDF Viewer Container -->
        <div id="pdf-viewer"
             class="mt-1 rounded-xl border border-slate-200/80 bg-[var(--bg)] overflow-auto"
             style="max-height: 75vh;">
        </div>

        <p class="mt-2 text-[11px] leading-relaxed text-[var(--ink-muted)]">
          Falls die Vorschau nicht geladen wird, kannst du die Datei
          <a href="/documents/{{ doc.id }}/download" class="text-sky-500 underline underline-offset-2">
            hier herunterladen
          </a>
          und lokal öffnen.
        </p>

        <!-- pdf.js von CDN laden -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js"></script>
        <script>
          document.addEventListener("DOMContentLoaded", function () {
            if (!window["pdfjsLib"]) {
              console.error("pdfjsLib nicht geladen");
              const viewer = document.getElementById("pdf-viewer");
              if (viewer) {
                viewer.innerHTML =
                  '<p class="text-sm text-red-600 p-3">Fehler beim Laden der PDF-Bibliothek.</p>';
              }
              return;
            }

            pdfjsLib.GlobalWorkerOptions.workerSrc =
              "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";

            const url = "/documents/{{ doc.id }}/download?inline=true";
            const viewer = document.getElementById("pdf-viewer");

            const loadingTask = pdfjsLib.getDocument(url);
            loadingTask.promise
              .then(function (pdf) {
                for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                  pdf.getPage(pageNum).then(function (page) {
                    const viewport = page.getViewport({ scale: 1.2 });

                    const canvas = document.createElement("canvas");
                    canvas.className = "block mx-auto mb-4 bg-white shadow-sm rounded-lg";
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;

                    viewer.appendChild(canvas);

                    const ctx = canvas.getContext("2d");
                    const renderContext = {
                      canvasContext: ctx,
                      viewport: viewport
                    };
                    page.render(renderContext);
                  });
                }
              })
              .catch(function (err) {
                console.error("PDF render error", err);
                if (viewer) {
                  viewer.innerHTML =
                    '<p class="text-sm text-red-600 p-3">Fehler beim Laden der PDF-Vorschau.</p>';
                }
              });
          });
        </script>

      {% elif is_docx %}
        <div class="flex items-center justify-between">
          <span class="text-xs font-medium uppercase tracking-wide text-[var(--ink-muted)]">
            Word-Dokument
          </span>
          <span class="text-[11px] text-[var(--ink-muted)]">
            Textvorschau, Layout kann abweichen
          </span>
        </div>

        {% if ocr_text %}
          <div class="mt-1 rounded-xl border border-slate-200/80 bg-[var(--bg)] p-4 overflow-y-auto"
               style="max-height: 75vh;">
            <div class="rounded-lg bg-white px-4 py-3 text-sm leading-relaxed text-slate-800 shadow-inner whitespace-pre-wrap">
              {{ ocr_text }}
            </div>
          </div>
        {% else %}
          <div class="mt-2 rounded-xl border border-dashed border-slate-300 bg-[var(--bg)]/80 p-4 text-sm text-[var(--ink-muted)]">
            Für dieses Word-Dokument konnte kein Text extrahiert werden.
            Lade die Originaldatei herunter und öffne sie in Word.
          </div>
        {% endif %}

        <p class="mt-2 text-[11px] text-[var(--ink-muted)]">
          Originaldatei:
          <a href="/documents/{{ doc.id }}/download" class="text-sky-500 underline underline-offset-2">
            als DOCX herunterladen
          </a>
        </p>

      {% else %}
        <div class="flex items-center justify-between">
          <span class="text-xs font-medium uppercase tracking-wide text-[var(--ink-muted)]">
            Textvorschau
          </span>
          <span class="text-[11px] text-[var(--ink-muted)]">
            Darstellung kann vom Original abweichen
          </span>
        </div>

        {% if ocr_text %}
          <div class="mt-1 rounded-xl border border-slate-200/80 bg-[var(--bg)] p-3 overflow-y-auto"
               style="max-height: 75vh;">
            <pre class="text-xs leading-relaxed text-[var(--ink)] whitespace-pre-wrap bg-white rounded-lg px-3 py-2 shadow-inner">
{{ ocr_text }}
            </pre>
          </div>
        {% else %}
          <div class="mt-2 rounded-xl border border-dashed border-slate-300 bg-[var(--bg)]/80 p-4 text-sm text-[var(--ink-muted)]">
            Für dieses Dokument liegt noch kein Text vor.
            Lade die Originaldatei herunter und öffne sie lokal.
          </div>
        {% endif %}
      {% endif %}
    </div>

    {# RIGHT: Details + Download #}
    <div class="rounded-2xl border border-slate-200/80 bg-[var(--card)]/95 shadow-sm p-4 space-y-4">

      <div class="space-y-3">
        <h2 class="text-sm font-semibold text-[var(--ink)]">Dokumentdetails</h2>
        <dl class="space-y-2 text-sm">
          <div class="flex items-center justify-between gap-4">
            <dt class="text-[var(--ink-muted)]">Dateiname</dt>
            <dd class="font-medium text-[var(--ink)] text-right truncate max-w-[220px]">
              {{ filename }}
            </dd>
          </div>
          <div class="flex items-center justify-between gap-4">
            <dt class="text-[var(--ink-muted)]">Typ</dt>
            <dd class="text-right text-[var(--ink)]">
              {% if is_pdf_view %}
                PDF
              {% elif is_docx %}
                Word (DOCX)
              {% else %}
                {{ doc.mime_type or doc.content_type or "unbekannt" }}
              {% endif %}
            </dd>
          </div>
          <div class="flex items-center justify-between gap-4">
            <dt class="text-[var(--ink-muted)]">Hochgeladen am</dt>
            <dd class="text-right text-[var(--ink)]">
              {{ doc.created_at.strftime("%d.%m.%Y %H:%M") if doc.created_at else "-" }}
            </dd>
          </div>
          <div class="flex items-center justify-between gap-4">
            <dt class="text-[var(--ink-muted)]">Kategorie</dt>
            <dd class="text-right text-[var(--ink)]">
              {% if doc.category %}
                {{ doc.category.name }}
              {% else %}
                —
              {% endif %}
            </dd>
          </div>
        </dl>
      </div>

      <div class="space-y-2 pt-2 border-t border-slate-200/80">
        <a href="/documents/{{ doc.id }}/download"
           class="inline-flex w-full items-center justify-center rounded-full bg-slate-900 px-4 py-2.5 text-xs font-semibold text-white shadow-sm hover:bg-slate-800">
          Herunterladen
        </a>
        <a href="/documents"
           class="inline-flex w-full items-center justify-center rounded-full border border-slate-300 bg-[var(--bg)] px-4 py-2.5 text-xs font-semibold text-[var(--ink)] shadow-sm hover:bg-slate-200/70">
          Zur Dokumentenübersicht
        </a>
      </div>
    </div>
  </div>
</div>
{% endblock %}
