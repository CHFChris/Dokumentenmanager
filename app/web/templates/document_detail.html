{% extends "base.html" %}
{% block title %}Document ¬∑ {{ doc.name }}{% endblock %}

{% block content %}
<a href="/documents" class="muted">‚Üê Back to Documents</a>

<h2 style="margin-top:6px">{{ doc.name }}</h2>
<p class="muted" style="margin-top:-6px;margin-bottom:18px">Document details, versions & actions</p>

<div class="grid grid-2">
  <!-- Left: Details -->
  <div class="card">
    <div class="card-hdr">Details & Metadata</div>
    <div class="card-body">
      {% set ext = (doc.name.rsplit('.',1)[-1]).upper() if '.' in doc.name else (doc.ext or 'FILE') %}
      <div class="grid" style="gap:10px">
        <div class="row">
          <span class="muted" style="width:140px">Upload Date</span>
          <span>{{ doc.created_at.strftime('%Y-%m-%d') if doc.created_at else '-' }}</span>
        </div>
        <div class="row">
          <span class="muted" style="width:140px">File Type</span>
          <span class="badge {{ 'red' if ext=='PDF' else ('green' if ext in ['TXT','MD'] else 'gray') }}">{{ ext }}</span>
        </div>
        <div class="row">
          <span class="muted" style="width:140px">MIME</span>
          <span>{{ (doc.mime or '') or '‚Äî' }}</span>
        </div>
        <div class="row">
          <span class="muted" style="width:140px">File Size</span>
          <span>
            {% if doc.size is not none %}
              {% if doc.size >= 1024*1024 %}
                {{ (doc.size/1024/1024)|round(2) }} MB
              {% elif doc.size >= 1024 %}
                {{ (doc.size/1024)|round(0) }} KB
              {% else %}
                {{ doc.size }} B
              {% endif %}
            {% else %}-{% endif %}
          </span>
        </div>
        <div class="row">
          <span class="muted" style="width:140px">SHA256</span>
          <code class="text-xs">{{ doc.sha256 or '‚Äî' }}</code>
        </div>
      </div>

      <hr style="margin:16px 0">

      <!-- Rename (creates a new version in backend) -->
      <form method="post" action="/documents/{{ doc.id }}/rename-web" class="row" style="gap:8px">
        <input class="input" type="text" name="new_name" value="{{ doc.name }}" required>
        <button class="btn">Rename (new version)</button>
      </form>

      {% if error %}
        <div class="mb-2" style="margin-top:12px">
          <div class="badge red">{{ error }}</div>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Right: Quick Actions -->
  <div class="card">
    <div class="card-hdr">Quick Actions</div>
    <div class="card-body grid" style="gap:10px">
      <div class="row" style="gap:8px; flex-wrap:wrap">
        <a class="btn primary" href="/documents/{{ doc.id }}/download">Download</a>
        <form method="post" action="/documents/{{ doc.id }}/delete-web" onsubmit="return confirm('Delete this file?')">
          <button class="btn">Delete</button>
        </form>
      </div>

      <div style="height:8px"></div>
      <div class="muted" style="font-weight:600">Upload new version</div>
      <form method="post" action="/documents/{{ doc.id }}/upload-version-web" enctype="multipart/form-data" class="grid" style="gap:8px">
        <input class="input" type="file" name="file" required>
        <input class="input" type="text" name="note" placeholder="Change note (optional)">
        <button class="btn">Upload</button>
      </form>
    </div>
  </div>
</div>

<!-- Versions -->
<div class="card" style="margin-top:16px">
  <div class="card-hdr">Versions</div>
  <div class="card-body">
    {% if versions and versions|length>0 %}
      <table role="grid">
        <thead>
          <tr>
            <th>Version</th>
            <th>Created</th>
            <th>Size</th>
            <th>Note</th>
            <th style="width:180px">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for v in versions %}
          <tr>
            <td>v{{ v.version_number }}</td>
            <td class="muted">
              {% if v.created_at %}{{ v.created_at.strftime('%Y-%m-%d %H:%M') }}{% else %}-{% endif %}
            </td>
            <td>
              {% set s = v.size_bytes or 0 %}
              {% if s>=1024*1024 %}
                {{ (s/(1024*1024))|round(2) }} MB
              {% elif s>=1024 %}
                {{ (s/1024)|round(0) }} KB
              {% else %}
                {{ s }} B
              {% endif %}
            </td>
            <td class="muted">{{ v.note or '‚Äî' }}</td>
            <td>
              <div class="row">
                <a class="btn" href="/documents/{{ doc.id }}/download?version_id={{ v.id }}">Download</a>
                <form method="post" action="/documents/{{ doc.id }}/restore-version-web" style="display:inline">
                  <input type="hidden" name="version_id" value="{{ v.id }}">
                  <button class="btn">Restore</button>
                </form>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <div class="empty">
        <div style="font-size:42px">üóÇÔ∏è</div>
        <div>No versions yet.</div>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}
