{# app/web/templates/upload.html #}
{% extends "base.html" %}
{% block title %}Upload · Dokumentenmanager{% endblock %}

{% block content %}
<div class="container mx-auto max-w-3xl py-8 px-4">

  <div class="mb-6">
    <h1 class="text-2xl font-semibold tracking-tight mb-1">
      Dokument hochladen
    </h1>
    <p class="text-sm text-gray-600 dark:text-gray-300">
      Füge neue Dateien zu deinem Dokumentenmanager hinzu und ordne sie direkt einer Kategorie zu.
    </p>
  </div>

  {% if error %}
    <div class="mb-4 rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-800 dark:border-red-500/60 dark:bg-red-950/40">
      {{ error }}
    </div>
  {% endif %}

  {% if duplicate_doc %}
    <div class="mb-4 rounded-2xl border border-slate-200 bg-white p-5 shadow-sm ring-1 ring-slate-100 dark:border-slate-700 dark:bg-slate-900 dark:ring-slate-800">
      <div class="flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between">
        <div class="flex gap-4">
          <div class="mt-0.5 flex h-11 w-11 flex-none items-center justify-center rounded-xl bg-emerald-600/10 text-emerald-700 dark:bg-emerald-400/10 dark:text-emerald-300">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 12h6" />
              <path d="M12 9v6" />
              <path d="M7 3h10a2 2 0 0 1 2 2v10" />
              <path d="M5 7H4a2 2 0 0 0-2 2v11a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2v-1" />
            </svg>
          </div>

          <div>
            <div class="text-lg font-semibold tracking-tight text-black">
              Duplikat erkannt
            </div>

            <div class="mt-2 text-[15px] leading-6 text-black">
              Diese Datei ist bereits vorhanden. Öffnen oder trotzdem speichern?
            </div>

            <div class="mt-4 max-w-[46rem] rounded-xl bg-slate-50 px-4 py-3 ring-1 ring-slate-200">
              <div class="flex items-start justify-between gap-3">
                <a
                  href="/documents/{{ duplicate_doc.id }}"
                  class="text-[15px] font-semibold leading-6 text-black underline decoration-black/30 underline-offset-2 hover:decoration-black/60 break-words"
                >
                  {{ duplicate_doc.filename }}
                </a>

                <span class="flex-none whitespace-nowrap text-xs font-medium text-black">
                  {{ (duplicate_doc.size_bytes / 1024)|round(1) }} KB
                </span>
              </div>
            </div>
          </div>
        </div>

        <div class="flex flex-wrap gap-2 sm:flex-col sm:items-stretch">
          <a
            href="/documents/{{ duplicate_doc.id }}"
            class="inline-flex items-center justify-center rounded-full bg-emerald-600 px-4 py-2 text-xs font-semibold text-white shadow-sm hover:bg-emerald-700"
          >
            Anzeigen
          </a>

          <button
            id="force-duplicate-button"
            type="button"
            class="inline-flex w-full items-center justify-center rounded-full bg-sky-600 px-4 py-2 text-xs font-semibold text-white shadow-sm hover:bg-sky-700"
          >
            Trotzdem speichern
          </button>
        </div>
      </div>
    </div>
  {% endif %}

  <div class="rounded-2xl border border-gray-200 dark:border-slate-800 bg-white dark:bg-slate-900 shadow-sm px-6 py-6 lg:px-8 lg:py-8">
    <form id="upload-form" action="/upload-web" method="post" enctype="multipart/form-data" class="space-y-6">

      <div>
        <h2 class="text-base font-semibold mb-1">
          Datei auswählen
        </h2>
        <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">
          Unterstützte Formate: PDF, DOCX, TXT. Der Inhalt wird für Suche und OCR automatisch vorbereitet.
        </p>

        <div
          id="file-dropzone"
          class="
            relative flex flex-col items-center justify-center gap-3
            rounded-2xl border border-dashed border-gray-300
            bg-white dark:bg-slate-100
            px-4 py-8 text-center
            text-sm text-gray-700
            transition-colors
          "
        >

          <svg class="h-10 w-10 text-gray-400 dark:text-gray-400" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M12 5v14m0-14l-5 5m5-5l5 5"
                  stroke="currentColor"
                  stroke-width="1.6"
                  stroke-linecap="round"
                  stroke-linejoin="round" />
          </svg>

          <div class="space-y-1">
            <div class="text-sm font-medium">
              Datei hier ablegen oder auswählen
            </div>
            <div class="text-xs text-gray-500 dark:text-gray-400">
              Drag & Drop wird unterstützt
            </div>
          </div>

          <button
            type="button"
            id="file-select-button"
            class="mt-2 inline-flex items-center rounded-xl bg-blue-600 px-4 py-2 text-xs font-semibold text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1 dark:focus:ring-offset-slate-950"
          >
            Datei auswählen
          </button>

          <input
            id="file-input"
            class="hidden"
            type="file"
            name="file"
            accept=".pdf,.docx,.txt"
            required
          >

          <p id="file-helper-text" class="mt-1 text-[11px] text-gray-500 dark:text-gray-400">
            Noch keine Datei ausgewählt.
          </p>
        </div>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-[minmax(0,2fr)_minmax(0,1fr)] gap-3 items-end">
        <div>
          <div class="block text-xs font-semibold text-gray-600 dark:text-gray-300 mb-1">
            Kategorien
          </div>

          <div class="max-h-48 overflow-auto rounded-xl border border-gray-300 bg-white p-3 text-sm text-gray-900 dark:border-slate-700 dark:bg-slate-900 dark:text-gray-100 space-y-2">
            {% if categories and categories|length > 0 %}
              {% for cat in categories %}
                <label class="flex items-center gap-2">
                  <input
                    type="checkbox"
                    name="category_ids"
                    value="{{ cat.id }}"
                    class="h-4 w-4 rounded border-gray-300"
                  >
                  <span class="text-sm">{{ cat.name }}</span>
                </label>
              {% endfor %}
            {% else %}
              <div class="text-xs text-gray-500 dark:text-gray-400">
                Keine Kategorien vorhanden
              </div>
            {% endif %}
          </div>

          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
            Mehrfachauswahl per Checkbox.
          </p>

          <label class="mt-3 flex items-start gap-2 text-xs text-gray-700 dark:text-gray-200">
            <input
              id="allow-duplicate"
              type="checkbox"
              name="allow_duplicate"
              value="1"
              class="mt-0.5 h-4 w-4 rounded border-gray-300"
            >
            <span>
              <span class="font-semibold">Duplikate trotzdem speichern</span>
              <span class="block text-[11px] text-gray-500 dark:text-gray-400">
                Erlaubt das Hochladen, auch wenn bereits ein identisches Dokument existiert.
              </span>
            </span>
          </label>
        </div>

        <button
          class="w-full inline-flex items-center justify-center rounded-xl bg-blue-600 px-4 py-2.5 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1 dark:focus:ring-offset-slate-950"
          type="submit"
        >
          Hochladen
        </button>
      </div>
    </form>

    <div class="mt-8 pt-6 border-t border-dashed border-gray-200 dark:border-slate-800">
      <h2 class="text-sm font-semibold mb-2">
        Neue Kategorie anlegen
      </h2>
      <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">
        Lege eigene Kategorien an, um deine Dokumente besser zu strukturieren
        (z. B. Rechnungen, Verträge, Schule).
      </p>

      <form action="/categories/create-web" method="post" class="flex flex-col sm:flex-row gap-3">
        <input
          class="flex-1 rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 dark:border-slate-700 dark:bg-slate-900 dark:text-gray-100"
          type="text"
          name="name"
          placeholder="Neue Kategorie (z. B. Rechnungen)"
          required
        >
        <button
          class="w-full sm:w-auto inline-flex items-center justify-center rounded-xl border border-gray-300 bg-gray-50 px-4 py-2.5 text-sm font-medium text-gray-800 hover:bg-gray-100 dark:border-slate-700 dark:bg-slate-900 dark:text-gray-100 dark:hover:bg-slate-800"
          type="submit"
        >
          Kategorie anlegen
        </button>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block body_end %}
{{ super() }}
<script>
  (function () {
    const dropzone = document.getElementById("file-dropzone");
    const fileInput = document.getElementById("file-input");
    const selectButton = document.getElementById("file-select-button");
    const helper = document.getElementById("file-helper-text");

    if (!dropzone || !fileInput) return;

    function setFiles(files) {
      if (!files || files.length === 0) return;
      fileInput.files = files;
      const name = files.length === 1
        ? files[0].name
        : files.length + " Dateien ausgewählt";
      if (helper) helper.textContent = name;
    }

    function setHighlight(on) {
      dropzone.classList.toggle("ring-2", on);
      dropzone.classList.toggle("ring-blue-400", on);

      dropzone.classList.toggle("bg-blue-50", on);
      dropzone.classList.toggle("dark:bg-blue-50", on);

      dropzone.classList.toggle("bg-white", !on);
      dropzone.classList.toggle("dark:bg-slate-100", !on);
    }

    ["dragenter", "dragover"].forEach(evt => {
      dropzone.addEventListener(evt, function (e) {
        e.preventDefault();
        e.stopPropagation();
        setHighlight(true);
      });
    });

    ["dragleave", "dragend", "drop"].forEach(evt => {
      dropzone.addEventListener(evt, function (e) {
        e.preventDefault();
        e.stopPropagation();
        if (evt !== "drop") setHighlight(false);
      });
    });

    dropzone.addEventListener("drop", function (e) {
      const files = e.dataTransfer.files;
      setHighlight(false);
      setFiles(files);
    });

    if (selectButton) {
      selectButton.addEventListener("click", function () {
        fileInput.click();
      });
    }

    fileInput.addEventListener("change", function () {
      setFiles(fileInput.files);
    });

    const forceBtn = document.getElementById("force-duplicate-button");
    const allowDup = document.getElementById("allow-duplicate");
    const uploadForm = document.getElementById("upload-form");

    if (forceBtn) {
      forceBtn.addEventListener("click", function () {
        if (allowDup) allowDup.checked = true;
        if (uploadForm) uploadForm.scrollIntoView({ behavior: "smooth", block: "start" });
        fileInput.click();
      });
    }
  })();
</script>
{% endblock %}
