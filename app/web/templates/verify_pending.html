{% extends "base.html" %}

{% block title %}E-Mail-Verifizierung · SPKH{% endblock %}

{% block content %}
<div class="max-w-md mx-auto mt-14 px-4">
  <div class="rounded-2xl border border-blue-200/70 dark:border-blue-500/40 bg-white dark:bg-slate-900/80 shadow-sm px-6 py-5">
    <h1 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-2">
      E-Mail-Verifizierung erforderlich
    </h1>
    <p class="text-sm text-gray-600 dark:text-gray-300 mb-2">
      Wir haben einen Verifizierungslink an
      <span class="font-medium">{{ email }}</span> gesendet.
    </p>

    {% if not mail_sent %}
      <p class="text-sm text-amber-700 bg-amber-50 dark:bg-amber-900/40 dark:text-amber-200 border border-amber-200/70 dark:border-amber-500/40 rounded-lg px-3 py-2 mb-3">
        Der Versand der E-Mail ist fehlgeschlagen. Du kannst die Verifizierungs-E-Mail unten erneut anfordern.
      </p>
    {% endif %}

    <form method="post" action="/auth/verify/resend" class="mt-3 flex gap-2">
      <input type="hidden" name="email" value="{{ email }}">
      <button
        type="submit"
        class="inline-flex flex-1 items-center justify-center rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-slate-800 px-4 py-2.5 text-sm font-medium text-gray-700 dark:text-gray-100 hover:bg-gray-50 dark:hover:bg-slate-700"
      >
        E-Mail erneut senden
      </button>
    </form>

    <p class="mt-4 text-xs text-gray-500 dark:text-gray-400">
      Diese Seite prüft regelmäßig, ob dein Account verifiziert wurde, und leitet dich automatisch weiter.
    </p>
  </div>
</div>

<script>
  const email = "{{ email }}";
  async function poll() {
    try {
      const r = await fetch(`/auth/verify/check?email=${encodeURIComponent(email)}`, { cache: "no-store" });
      const j = await r.json();
      if (j.verified) {
        window.location.href = "/auth/login-web?verified=ok";
        return;
      }
    } catch (e) {
      // still retry
    }
    setTimeout(poll, 4000);
  }
  poll();
</script>
{% endblock %}
