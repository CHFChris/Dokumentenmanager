{% extends "base.html" %}

{% block title %}Kategorien & Schlagwörter{% endblock %}

{% block content %}
<div class="mx-auto max-w-6xl px-4 py-6 space-y-6">

  <!-- Header / Toolbar -->
  <div class="flex items-center justify-between gap-3">
    <div>
      <div class="text-[11px] uppercase tracking-wide text-[var(--ink-muted)] mb-1">
        Kategorien & Schlagwörter
      </div>
      <h1 class="text-2xl font-semibold text-[var(--ink)]">
        Kategorien verwalten
      </h1>
      <p class="mt-1 text-sm text-[var(--ink-muted)]">
        Eigene Schlagwörter pflegen und KI-Vorschläge aus OCR-Texten verwalten.
      </p>
    </div>
    <a href="/documents"
       class="inline-flex items-center rounded-full border border-slate-300 bg-[var(--bg)] px-4 py-1.5 text-xs font-medium text-[var(--ink)] shadow-sm hover:bg-slate-200/70">
      Zur Dokumentenübersicht
    </a>
  </div>

  <div class="grid gap-5 md:grid-cols-3">

    <!-- linke Spalte: Kategorienliste -->
    <div class="md:col-span-1">
      <div class="rounded-2xl border border-slate-200/80 bg-[var(--card)]/95 shadow-sm h-full flex flex-col">
        <div class="border-b border-slate-200/80 px-4 py-3">
          <div class="text-[11px] font-semibold uppercase tracking-wide text-[var(--ink-muted)]">
            Kategorien
          </div>
        </div>
        <div class="px-4 pt-3 pb-4">
          <p class="mb-2 text-xs text-[var(--ink-muted)]">
            Wähle eine Kategorie aus, um ihre Schlagwörter zu bearbeiten.
          </p>
          <div id="category-list"
               class="mt-2 rounded-2xl border border-slate-200/80 bg-[var(--bg)]/60 overflow-y-auto max-h-[70vh]">
            {% for cat in categories %}
              <button
                type="button"
                class="category-item flex w-full items-center justify-between px-3 py-2 text-sm text-[var(--ink)] hover:bg-slate-900/5 border-b border-slate-200/60 last:border-b-0"
                data-category-id="{{ cat.id }}"
                data-category-name="{{ cat.name }}"
              >
                <span class="truncate">{{ cat.name }}</span>
              </button>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <!-- rechte Spalte: Schlagwörter -->
    <div class="md:col-span-2 space-y-4">

      <!-- Platzhalter, wenn keine Kategorie ausgewählt ist -->
      <div id="no-category-panel"
           class="rounded-2xl border border-dashed border-slate-300/80 bg-[var(--card)]/60 px-5 py-6 shadow-sm">
        <div class="mb-2 text-sm font-semibold text-[var(--ink)]">
          Keine Kategorie ausgewählt
        </div>
        <p class="text-xs text-[var(--ink-muted)]">
          Wähle links eine Kategorie aus, um eigene Schlagwörter und KI-Vorschläge anzuzeigen und zu bearbeiten.
        </p>
      </div>

      <!-- Panel für gewählte Kategorie -->
      <div id="category-keywords-panel" class="space-y-4 hidden">

        <!-- Aktive Kategorie Kopfbereich -->
        <div class="rounded-2xl border border-slate-200/80 bg-[var(--card)]/95 px-5 py-4 shadow-sm">
          <div class="flex flex-wrap items-center justify-between gap-3">
            <div>
              <div class="text-[11px] uppercase tracking-wide text-[var(--ink-muted)]">
                Aktive Kategorie
              </div>
              <div class="text-lg font-semibold text-[var(--ink)]" id="category-title">Kategorie</div>
            </div>
            <p class="max-w-xs text-[11px] text-right text-[var(--ink-muted)]">
              Vorschläge basieren auf OCR-Texten deiner Dokumente in dieser Kategorie.
            </p>
          </div>
        </div>

        <!-- Eigene Keywords -->
        <div class="rounded-2xl border border-slate-200/80 bg-[var(--card)]/95 shadow-sm">
          <div class="flex items-center justify-between border-b border-slate-200/80 px-5 py-3">
            <div class="text-sm font-semibold text-[var(--ink)]">Eigene Schlagwörter</div>
            <span class="inline-flex items-center rounded-full border border-slate-300 bg-[var(--bg)] px-2.5 py-1 text-[11px] text-[var(--ink-muted)]">
              Manuell gepflegt
            </span>
          </div>
          <div class="px-5 py-4 space-y-4">
            <p class="text-xs text-[var(--ink-muted)]">
              Diese Schlagwörter hast du selbst für die Kategorie definiert.
            </p>

            <!-- Liste eigener Keywords -->
            <div id="existing-keywords" class="text-xs text-[var(--ink-muted)]">
              <span>Keine eigenen Schlagwörter definiert.</span>
            </div>

            <!-- Eingabe / Hinzufügen -->
            <div class="flex flex-col gap-2 sm:flex-row sm:items-center">
              <div class="sm:flex-1">
                <input
                  type="text"
                  id="new-keyword-input"
                  class="w-full rounded-xl border border-slate-300 bg-[var(--bg)] px-3 py-2 text-sm text-[var(--ink)] shadow-sm focus:border-slate-500 focus:outline-none focus:ring-1 focus:ring-slate-500"
                  placeholder="Neues Schlagwort eingeben"
                >
              </div>
              <div class="sm:w-auto">
                <button
                  class="inline-flex w-full items-center justify-center rounded-full bg-slate-900 px-4 py-2 text-xs font-medium text-white shadow-sm hover:bg-slate-800"
                  id="add-keyword-btn"
                  type="button"
                >
                  Schlagwort hinzufügen
                </button>
              </div>
            </div>

            <p class="text-[11px] text-[var(--ink-muted)]">
              Einzelne Schlagwörter können über das „x“ gelöscht werden. Änderungen werden automatisch gespeichert.
            </p>
          </div>
        </div>

        <!-- OCR-Vorschläge -->
        <div class="rounded-2xl border border-slate-200/80 bg-[var(--card)]/95 shadow-sm">
          <div class="flex items-center justify-between border-b border-slate-200/80 px-5 py-3">
            <div class="text-sm font-semibold text-[var(--ink)]">Schlagwörter aus OCR</div>
            <span class="inline-flex items-center rounded-full border border-slate-300 bg-[var(--bg)] px-2.5 py-1 text-[11px] text-[var(--ink-muted)]">
              KI-Vorschläge
            </span>
          </div>
          <div class="px-5 py-4 space-y-3">
            <p class="text-xs text-[var(--ink-muted)]">
              Diese Schlagwörter wurden automatisch aus den OCR-Texten deiner Dokumente in dieser Kategorie erkannt.
            </p>

            <!-- Liste der Vorschläge -->
            <div id="suggested-keywords" class="text-xs text-[var(--ink-muted)]">
              <span>Noch keine Vorschläge vorhanden.</span>
            </div>

            <p class="text-[11px] text-[var(--ink-muted)]">
              Das „x“ blendet einzelne Vorschläge aus. Die Vorschläge werden nicht dauerhaft gespeichert, sondern dienen als Orientierung.
            </p>
          </div>
        </div>

      </div>

    </div>
  </div>
</div>

<script>
let currentCategoryId = null;
let currentKeywords = [];

// Hilfsfunktion: Badge für ein Keyword (mit X-Button)
function createKeywordBadge(text, options) {
  const { extraClass, deletable, onDelete } = options || {};

  const span = document.createElement("span");
  span.className =
    "inline-flex items-center rounded-full border border-slate-300 px-2.5 py-1 text-[11px] text-[var(--ink)] mr-1 mb-1 " +
    (extraClass || "");

  const label = document.createElement("span");
  label.textContent = text;
  label.className = "mr-1";
  span.appendChild(label);

  if (deletable && typeof onDelete === "function") {
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "ml-0.5 text-[10px] text-slate-500 hover:text-slate-700";
    btn.textContent = "×";
    btn.addEventListener("click", function (ev) {
      ev.stopPropagation();
      onDelete();
    });
    span.appendChild(btn);
  }

  return span;
}

// Rendering: eigene Keywords
function renderExistingKeywords() {
  const container = document.getElementById("existing-keywords");
  container.innerHTML = "";

  if (!currentKeywords || currentKeywords.length === 0) {
    container.innerHTML =
      '<span class="text-[11px] text-[var(--ink-muted)]">Keine eigenen Schlagwörter definiert.</span>';
    return;
  }

  currentKeywords.forEach((kw) => {
    const badge = createKeywordBadge(kw, {
      extraClass: "bg-[var(--bg)]",
      deletable: true,
      onDelete: () => removeKeyword(kw),
    });
    container.appendChild(badge);
  });
}

// Rendering: Vorschlags-Keywords
function renderSuggestedKeywords(list) {
  const container = document.getElementById("suggested-keywords");
  container.innerHTML = "";

  if (!list || list.length === 0) {
    container.innerHTML =
      '<span class="text-[11px] text-[var(--ink-muted)]">Noch keine Vorschläge vorhanden.</span>';
    return;
  }

  list.forEach((kw) => {
    const badge = createKeywordBadge(kw, {
      extraClass: "bg-[var(--bg)]",
      deletable: true,
      onDelete: () => {
        badgeRef.remove();
      },
    });
    const badgeRef = badge;
    container.appendChild(badgeRef);
  });
}

// API: Keywords speichern (PATCH)
function saveKeywords() {
  if (!currentCategoryId) {
    return;
  }
  return fetch(`/api/categories/${currentCategoryId}/keywords`, {
    method: "PATCH",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({ keywords: currentKeywords }),
  })
    .then((response) => {
      if (!response.ok) {
        throw new Error("HTTP " + response.status);
      }
      return response.json();
    })
    .then((data) => {
      const raw = data.keywords || "";
      currentKeywords = raw
        .split(",")
        .map((k) => k.trim())
        .filter((k) => k.length > 0);
      renderExistingKeywords();
    })
    .catch((err) => {
      console.error("Fehler beim Speichern der Keywords:", err);
    });
}

// Keyword hinzufügen
function addKeywordFromInput() {
  if (!currentCategoryId) {
    return;
  }
  const input = document.getElementById("new-keyword-input");
  const value = (input.value || "").trim();
  if (!value) {
    return;
  }

  if (!currentKeywords.includes(value)) {
    currentKeywords.push(value);
  }
  input.value = "";
  renderExistingKeywords();
  saveKeywords();
}

// Keyword entfernen
function removeKeyword(kw) {
  if (!currentCategoryId) {
    return;
  }
  currentKeywords = currentKeywords.filter((k) => k !== kw);
  renderExistingKeywords();
  saveKeywords();
}

// UI-Update für eine Kategorie
function loadCategoryKeywords(categoryId, categoryName) {
  currentCategoryId = categoryId;
  const panel = document.getElementById("category-keywords-panel");
  const noPanel = document.getElementById("no-category-panel");
  const titleEl = document.getElementById("category-title");
  const existingEl = document.getElementById("existing-keywords");
  const suggestedEl = document.getElementById("suggested-keywords");

  titleEl.textContent = categoryName;

  panel.classList.remove("hidden");
  noPanel.classList.add("hidden");

  existingEl.innerHTML =
    '<span class="text-[11px] text-[var(--ink-muted)]">Lade Daten...</span>';
  suggestedEl.innerHTML =
    '<span class="text-[11px] text-[var(--ink-muted)]">Lade Daten...</span>';

  fetch(`/api/categories/${categoryId}/keyword-suggestions`)
    .then((response) => {
      if (!response.ok) {
        throw new Error("HTTP " + response.status);
      }
      return response.json();
    })
    .then((data) => {
      currentKeywords =
        (data.existing_keywords || []).map((k) => String(k).trim());
      renderExistingKeywords();

      renderSuggestedKeywords(data.suggested_keywords || []);
    })
    .catch((err) => {
      console.error("Fehler beim Laden der Keyword-Suggestions:", err);
      existingEl.innerHTML =
        '<span class="text-[11px] text-red-500">Fehler beim Laden der Daten.</span>';
      suggestedEl.innerHTML =
        '<span class="text-[11px] text-red-500">Fehler beim Laden der Daten.</span>';
    });
}

// Click-Handler für Kategorienliste
document.addEventListener("DOMContentLoaded", function () {
  const items = document.querySelectorAll(".category-item");
  items.forEach((item) => {
    item.addEventListener("click", function () {
      // Styling zurücksetzen
      items.forEach((it) => {
        it.classList.remove(
          "bg-slate-900/10",
          "border-slate-400",
          "shadow-sm"
        );
      });
      // aktives Item hervorheben
      this.classList.add(
        "bg-slate-900/10",
        "border-slate-400",
        "shadow-sm"
      );

      const catId = this.getAttribute("data-category-id");
      const catName = this.getAttribute("data-category-name");
      loadCategoryKeywords(catId, catName);
    });
  });

  const addBtn = document.getElementById("add-keyword-btn");
  addBtn.addEventListener("click", function () {
    addKeywordFromInput();
  });

  const input = document.getElementById("new-keyword-input");
  input.addEventListener("keydown", function (ev) {
    if (ev.key === "Enter") {
      ev.preventDefault();
      addKeywordFromInput();
    }
  });
});
</script>
{% endblock %}
